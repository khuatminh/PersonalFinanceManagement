<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{fragments/layout :: head}">
    <title>Chỉnh sửa giao dịch - Quản lý Tài chính Cá nhân</title>
</head>

<body class="d-flex flex-column min-vh-100">
    <!-- Navigation -->
    <div th:replace="~{fragments/layout :: navbar}"></div>

    <!-- Flash Messages -->
    <div th:replace="~{fragments/layout :: flash-messages}"></div>

    <!-- Main Content -->
    <main class="container mb-4 flex-grow-1">
        <!-- Page Header -->
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">
                <i class="bi bi-pencil"></i> Chỉnh sửa giao dịch
                <small class="text-muted">Cập nhật chi tiết giao dịch</small>
            </h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <a th:href="@{/transactions}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Quay lại Giao dịch
                </a>
            </div>
        </div>

        <!-- Edit Transaction Form -->
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card shadow">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-pencil-square"></i> Cập nhật chi tiết giao dịch
                        </h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/transactions/edit/{id}(id=${transaction.id})}" th:object="${transactionForm}" method="post" novalidate>

                            <!-- Transaction Type -->
                            <div class="mb-3">
                                <label class="form-label">Loại giao dịch *</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="type" id="income" 
                                           th:field="*{type}" value="INCOME" autocomplete="off">
                                    <label class="btn btn-outline-success" for="income">
                                        <i class="bi bi-arrow-up-circle"></i> Thu nhập
                                    </label>

                                    <input type="radio" class="btn-check" name="type" id="expense"
                                           th:field="*{type}" value="EXPENSE" autocomplete="off">
                                    <label class="btn btn-outline-danger" for="expense">
                                        <i class="bi bi-arrow-down-circle"></i> Chi tiêu
                                    </label>
                                </div>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('type')}" th:errors="*{type}">
                                    Loại giao dịch là bắt buộc
                                </div>
                            </div>

                            <!-- Description -->
                            <div class="mb-3">
                                <label for="description" class="form-label">Mô tả *</label>
                                <input type="text" class="form-control" id="description" th:field="*{description}"
                                       placeholder="ví dụ: Mua sắm tạp hóa, Thanh toán lương" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('description')}" th:errors="*{description}">
                                    Mô tả là bắt buộc
                                </div>
                            </div>

                            <!-- Amount -->
                            <div class="mb-3">
                                <label for="amount" class="form-label">Số tiền *</label>
                                <div class="input-group">
                                    <span class="input-group-text">VND</span>
                                    <input type="number" class="form-control" id="amount" th:field="*{amount}"
                                           step="1" min="1" placeholder="0" required>
                                </div>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('amount')}" th:errors="*{amount}">
                                    Số tiền là bắt buộc và phải lớn hơn 0
                                </div>
                            </div>

                            <!-- Category -->
                            <div class="mb-3">
                                <label for="categoryId" class="form-label">Danh mục *</label>
                                <select class="form-select" id="categoryId" th:field="*{categoryId}" required>
                                    <option value="">Chọn một danh mục</option>
                                    <optgroup label="Danh mục Thu nhập" th:if="${incomeCategories}">
                                        <option th:each="category : ${incomeCategories}"
                                                th:value="${category.id}"
                                                th:text="${category.name}"
                                                th:selected="${category.id == transactionForm.categoryId}">Danh mục Thu nhập</option>
                                    </optgroup>
                                    <optgroup label="Danh mục Chi tiêu" th:if="${expenseCategories}">
                                        <option th:each="category : ${expenseCategories}"
                                                th:value="${category.id}"
                                                th:text="${category.name}"
                                                th:selected="${category.id == transactionForm.categoryId}">Danh mục Chi tiêu</option>
                                    </optgroup>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('categoryId')}" th:errors="*{categoryId}">
                                    Danh mục là bắt buộc
                                </div>
                            </div>

                            <!-- Transaction Date -->
                            <div class="mb-3">
                                <label for="transactionDate" class="form-label">Ngày giao dịch</label>
                                <input type="datetime-local" class="form-control" id="transactionDate"
                                       th:field="*{transactionDate}">
                                <small class="form-text text-muted">Ngày ban đầu sẽ được giữ lại nếu để trống</small>
                            </div>

                            <!-- Notes -->
                            <div class="mb-3">
                                <label for="notes" class="form-label">Ghi chú</label>
                                <textarea class="form-control" id="notes" th:field="*{notes}" rows="3"
                                          placeholder="Ghi chú bổ sung về giao dịch này (tùy chọn)"></textarea>
                            </div>

                            <!-- Form Actions -->
                            <div class="d-flex justify-content-between">
                                <div>
                                    <a th:href="@{/transactions}" class="btn btn-secondary">
                                        <i class="bi bi-x-circle"></i> Hủy
                                    </a>
                                    <button type="button" class="btn btn-outline-danger ms-2"
                                            th:onclick="'confirmDelete(' + ${transaction.id} + ')'">
                                        <i class="bi bi-trash"></i> Xóa
                                    </button>
                                </div>
                                <button type="submit" class="btn btn-warning">
                                    <i class="bi bi-check-circle"></i> Cập nhật giao dịch
                                </button>
                            </div>

                            <!-- Global Form Errors -->
                            <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger mt-3">
                                <ul class="mb-0">
                                    <li th:each="error : ${#fields.globalErrors()}" th:text="${error}">Global error</li>
                                </ul>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Transaction Info -->
                <div class="card shadow mt-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="bi bi-info-circle"></i> Thông tin giao dịch
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Tạo lúc:</strong> <span th:text="${#temporals.format(transaction.createdAt, 'MMM dd, yyyy HH:mm')}">Jan 01, 2024 10:30</span></p>
                                <p><strong>ID giao dịch:</strong> <span th:text="${transaction.id}">123</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Danh mục hiện tại:</strong>
                                    <span class="badge"
                                          th:style="'background-color: ' + ${transaction.category.color}"
                                          th:text="${transaction.category.name}">Category</span>
                                </p>
                                <p><strong>Loại hiện tại:</strong>
                                    <span class="badge"
                                          th:class="${transaction.type.name() == 'INCOME' ? 'bg-success' : 'bg-danger'}"
                                          th:text="${transaction.type.displayName}">Type</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer th:replace="~{fragments/layout :: footer}"></footer>

    <!-- Scripts -->
    <div th:replace="~{fragments/layout :: scripts}"></div>

    <script>
        // Auto-select appropriate categories based on transaction type
        document.addEventListener('DOMContentLoaded', function() {
            const incomeRadio = document.getElementById('income');
            const expenseRadio = document.getElementById('expense');
            const categorySelect = document.getElementById('categoryId');
            
            function updateCategoryOptions() {
                const incomeOptgroup = categorySelect.querySelector('optgroup[label="Danh mục Thu nhập"]');
                const expenseOptgroup = categorySelect.querySelector('optgroup[label="Danh mục Chi tiêu"]');
                
                if (incomeRadio.checked) {
                    if (incomeOptgroup) incomeOptgroup.style.display = 'block';
                    if (expenseOptgroup) expenseOptgroup.style.display = 'none';
                } else if (expenseRadio.checked) {
                    if (incomeOptgroup) incomeOptgroup.style.display = 'none';
                    if (expenseOptgroup) expenseOptgroup.style.display = 'block';
                } else {
                    if (incomeOptgroup) incomeOptgroup.style.display = 'block';
                    if (expenseOptgroup) expenseOptgroup.style.display = 'block';
                }
            }
            
            incomeRadio.addEventListener('change', updateCategoryOptions);
            expenseRadio.addEventListener('change', updateCategoryOptions);
            
            // Initial setup
            updateCategoryOptions();
        });

        function confirmDelete(transactionId) {
            if (confirm('Bạn có chắc chắn muốn xóa giao dịch này? Hành động này không thể hoàn tác.')) {
                window.location.href = '/transactions/delete/' + transactionId;
            }
        }
    </script>
</body>
</html>
